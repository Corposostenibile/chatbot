# Dockerfile per sviluppo con hot reload
FROM python:3.11-slim

# Imposta variabili d'ambiente per Python
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Installa Poetry e curl per health checks
RUN pip install poetry && apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Configura Poetry
ENV POETRY_VENV_IN_PROJECT=1 \
    POETRY_NO_INTERACTION=1 \
    POETRY_CACHE_DIR=/opt/poetry_cache

# Imposta la directory di lavoro
WORKDIR /app

# Copia i file di configurazione Poetry e README
COPY pyproject.toml poetry.lock* README.md ./

# Copia la cartella app (necessaria per Poetry)
COPY app/ ./app/

# Installa tutte le dipendenze (incluse quelle di sviluppo)
RUN poetry install

# Trova dinamicamente il path dell'ambiente virtuale e crea un symlink
RUN VENV_PATH=$(poetry env info --path) && \
    ln -sf "$VENV_PATH" /app/.venv

# Imposta il PATH per usare l'ambiente virtuale
ENV PATH="/app/.venv/bin:$PATH"

# Esponi la porta
EXPOSE 8081

# Comando per avviare l'applicazione
CMD ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8081", "--reload"]